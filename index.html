<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>JsFeat experiments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="vendor/js/jsfeat.js"></script>
    <script src="vendor/js/dat.gui.js"></script>
  </head>
  <body>

    <video id="webcam" width="640" height="480" autoplay style="display:none"></video>
    <div>
      <canvas id="canvas" width="640" height="480"></canvas>
    </div>

    <script>
      const video = document.getElementById("webcam");
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      const height = canvas.height;
      const width = canvas.width;
      const image = new jsfeat.matrix_t(width, height, jsfeat.U8C1_t);
      const contourTimeout = 100;
      const maxArea = width * height;
      const options = {
        blur_radius: 2,
        low_threshold: 20,
        high_threshold: 50,
      };

      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                               navigator.mozGetUserMedia || navigator.msGetUserMedia;

      const onerror = function (error) {
        console.error(error);
      };

      if (!!navigator.getUserMedia) {
        setupGUI();

        navigator.getUserMedia({ video: true }, function (localMediaStream) {
          video.src = window.URL.createObjectURL(localMediaStream);

          requestAnimationFrame(tick);
        }, onerror);
      } else {
        alert("getUserMedia is not supported in your browser");
      }

      function setupGUI() {
        const gui = new dat.GUI();

        gui.add(options, "blur_radius", 0, 4).step(1);
        gui.add(options, "low_threshold", 1, 127).step(1);
        gui.add(options, "high_threshold", 1, 127).step(1);
      }

      function drawPoly(context, points) {
        if (!points) {
          return;
        }

        context.beginPath();
        context.moveTo(points[0].x, points[0].y);

        for (let i = 0; i < points.length; i++) {
          context.lineTo(points[i].x, points[i].y);
        }

        context.closePath();
        context.strokeStyle = "#ff0000";
        context.lineWidth = 4;
        context.stroke();
      }

      let wait = false;
      let maxContour;

      const contourFinderWorker = new Worker("js/contour-worker.js");
      contourFinderWorker.addEventListener("message", function (e) {
        maxContour = e.data;
      });

      function tick() {
        requestAnimationFrame(tick);

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          context.drawImage(video, 0, 0, 640, 480);

          const imageData = context.getImageData(0, 0, 640, 480);
          jsfeat.imgproc.grayscale(imageData.data, 640, 480, image);

          const r = options.blur_radius|0;
          const kernel_size = (r+1) << 1;

          jsfeat.imgproc.gaussian_blur(image, image, kernel_size, 0);
          jsfeat.imgproc.canny(image, image, options.low_threshold|0, options.high_threshold|0);

          // render result back to canvas
          let data_u32 = new Uint32Array(imageData.data.buffer);
          const alpha = (0xff << 24);
          let i = image.cols*image.rows, pix = 0;

          while(--i >= 0) {
            pix = image.data[i];
            data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
          }
          context.putImageData(imageData, 0, 0);
          drawPoly(context, maxContour);

          if (!wait) {
            setTimeout(function () {
              wait = false;
            }, 250);

            contourFinderWorker.postMessage(imageData);
            wait = true;
          };
        }
      }
    </script>
  </body>
</html>
